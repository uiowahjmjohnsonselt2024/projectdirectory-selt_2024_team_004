<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Projectdirectory-selt 2024 team 004</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.13.1/application.js' type='text/javascript'></script>
    <link href='./assets/0.13.1/application.css' media='screen, projection, print' rel='stylesheet' type='text/css' />
    <link rel="icon" type="image/png" href="./assets/0.13.1/favicon_red.png" />
  </head>

  <body>
    <div id="loading">
      <img src="./assets/0.13.1/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" class="hide">
      <div class="timestamp">Generated <abbr class="timeago" title="2024-12-14T10:20:22-06:00">2024-12-14T10:20:22-06:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent">
      <span class="red">
  3.83%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.07
       </span>
    </span> hits/line
    )
  </h2>

  <a name="AllFiles"></a>

  <div>
    <b>22</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>1097</b> relevant lines,
    <span class="green"><b>42</b> lines covered</span> and
    <span class="red"><b>1055</b> lines missed. </span>
    (<span class="red">
  3.83%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3c82a75566e01a07b3230a2b7302b4eb768a5acc" class="src_link" title="app/channels/game_channel.rb">app/channels/game_channel.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">21</td>
            <td class="cell--number">17</td>
            <td class="cell--number">0</td>
            <td class="cell--number">17</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8c6f1f3e33655db143a5e8282346ff40b163613f" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">22</td>
            <td class="cell--number">0</td>
            <td class="cell--number">22</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a7959005965f0a65860e5a319b6635f73e6435da" class="src_link" title="app/controllers/characters_controller.rb">app/controllers/characters_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">68</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e2542a02fa49b87ded4b175e9e93d0df73549058" class="src_link" title="app/controllers/invitations_controller.rb">app/controllers/invitations_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">75</td>
            <td class="cell--number">66</td>
            <td class="cell--number">0</td>
            <td class="cell--number">66</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c3424d1968c05f18c2669242ef913dd8a5d1b4d8" class="src_link" title="app/controllers/matching_game_controller.rb">app/controllers/matching_game_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">53</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#938b2467ba981791d886f2d5bf23ecca747c6cec" class="src_link" title="app/controllers/sessions_controller.rb">app/controllers/sessions_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">20</td>
            <td class="cell--number">0</td>
            <td class="cell--number">20</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#034fc7a4eedf1f1e76ebd5fafab28d4b20814b7a" class="src_link" title="app/controllers/settings_controller.rb">app/controllers/settings_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">38</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#fe4145bb4243f300b228bb5a7084938aaf8db60b" class="src_link" title="app/controllers/squares_controller.rb">app/controllers/squares_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">144</td>
            <td class="cell--number">117</td>
            <td class="cell--number">0</td>
            <td class="cell--number">117</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8624b070422e76f4aa14fff46547d0d497f69cb1" class="src_link" title="app/controllers/users_controller.rb">app/controllers/users_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">27</td>
            <td class="cell--number">21</td>
            <td class="cell--number">0</td>
            <td class="cell--number">21</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#1a94853ca1151736bcd3878fb64ff1e95f6788a2" class="src_link" title="app/controllers/worlds_controller.rb">app/controllers/worlds_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">533</td>
            <td class="cell--number">422</td>
            <td class="cell--number">0</td>
            <td class="cell--number">422</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#402f23aa711eeb1fb182c2ab12ed7d9b6bd60e70" class="src_link" title="app/helpers/squares_helper.rb">app/helpers/squares_helper.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">10</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ad654c0d32f54187d9ff082515e25bff345fb4b5" class="src_link" title="app/models/character.rb">app/models/character.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">11</td>
            <td class="cell--number">7</td>
            <td class="cell--number">7</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.71</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5a1396c2ad8dcb2723e5f0ec9c0b9c6c82c05033" class="src_link" title="app/models/invitation.rb">app/models/invitation.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">11</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#bd2892c9577dd72f130feb1e6ebc4e5df10de2ac" class="src_link" title="app/models/matching_game.rb">app/models/matching_game.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">78</td>
            <td class="cell--number">54</td>
            <td class="cell--number">0</td>
            <td class="cell--number">54</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2ab5ea69f5ac590521137fd166e3ea9c59fc4266" class="src_link" title="app/models/square.rb">app/models/square.rb</a></td>
            <td class="red strong cell--number t-file__coverage">45.45 %</td>
            <td class="cell--number">54</td>
            <td class="cell--number">22</td>
            <td class="cell--number">10</td>
            <td class="cell--number">12</td>
            <td class="cell--number">0.91</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#646b5ec673b8862ab13b4639c9b8f7a97beac44f" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">20</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.79</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#7142763a24b9b72e2813bb6fe81293f1b9f422e9" class="src_link" title="app/models/user_world.rb">app/models/user_world.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">14</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f530784403ecd253d3c307afab43db653b927825" class="src_link" title="app/models/world.rb">app/models/world.rb</a></td>
            <td class="red strong cell--number t-file__coverage">64.71 %</td>
            <td class="cell--number">30</td>
            <td class="cell--number">17</td>
            <td class="cell--number">11</td>
            <td class="cell--number">6</td>
            <td class="cell--number">0.94</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a63af90be4f84f247279104ae8ca657e19d0427e" class="src_link" title="app/services/fake_payment_service.rb">app/services/fake_payment_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">20</td>
            <td class="cell--number">15</td>
            <td class="cell--number">0</td>
            <td class="cell--number">15</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5fd694065847678d86cc57c298f96581bb20fb08" class="src_link" title="app/services/open_exchange_service.rb">app/services/open_exchange_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">24</td>
            <td class="cell--number">21</td>
            <td class="cell--number">0</td>
            <td class="cell--number">21</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5418263317411b8042b0e65f068c80fb6ba99d0f" class="src_link" title="app/services/openai_service.rb">app/services/openai_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">106</td>
            <td class="cell--number">90</td>
            <td class="cell--number">0</td>
            <td class="cell--number">90</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c435cb53ac61b47f2879aa1c55f410c8d9dab8ab" class="src_link" title="app/services/store_service.rb">app/services/store_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">27</td>
            <td class="cell--number">22</td>
            <td class="cell--number">0</td>
            <td class="cell--number">22</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Controllers"></a>

  <div>
    <b>9</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>789</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>789</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8c6f1f3e33655db143a5e8282346ff40b163613f" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">22</td>
            <td class="cell--number">0</td>
            <td class="cell--number">22</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a7959005965f0a65860e5a319b6635f73e6435da" class="src_link" title="app/controllers/characters_controller.rb">app/controllers/characters_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">68</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e2542a02fa49b87ded4b175e9e93d0df73549058" class="src_link" title="app/controllers/invitations_controller.rb">app/controllers/invitations_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">75</td>
            <td class="cell--number">66</td>
            <td class="cell--number">0</td>
            <td class="cell--number">66</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c3424d1968c05f18c2669242ef913dd8a5d1b4d8" class="src_link" title="app/controllers/matching_game_controller.rb">app/controllers/matching_game_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">53</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#938b2467ba981791d886f2d5bf23ecca747c6cec" class="src_link" title="app/controllers/sessions_controller.rb">app/controllers/sessions_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">20</td>
            <td class="cell--number">0</td>
            <td class="cell--number">20</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#034fc7a4eedf1f1e76ebd5fafab28d4b20814b7a" class="src_link" title="app/controllers/settings_controller.rb">app/controllers/settings_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">38</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#fe4145bb4243f300b228bb5a7084938aaf8db60b" class="src_link" title="app/controllers/squares_controller.rb">app/controllers/squares_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">144</td>
            <td class="cell--number">117</td>
            <td class="cell--number">0</td>
            <td class="cell--number">117</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8624b070422e76f4aa14fff46547d0d497f69cb1" class="src_link" title="app/controllers/users_controller.rb">app/controllers/users_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">27</td>
            <td class="cell--number">21</td>
            <td class="cell--number">0</td>
            <td class="cell--number">21</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#1a94853ca1151736bcd3878fb64ff1e95f6788a2" class="src_link" title="app/controllers/worlds_controller.rb">app/controllers/worlds_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">533</td>
            <td class="cell--number">422</td>
            <td class="cell--number">0</td>
            <td class="cell--number">422</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Channels">
  <h2>
    <span class="group_name">Channels</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Channels"></a>

  <div>
    <b>1</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>17</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>17</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3c82a75566e01a07b3230a2b7302b4eb768a5acc" class="src_link" title="app/channels/game_channel.rb">app/channels/game_channel.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">21</td>
            <td class="cell--number">17</td>
            <td class="cell--number">0</td>
            <td class="cell--number">17</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent">
      <span class="red">
  31.58%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.55
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Models"></a>

  <div>
    <b>7</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>133</b> relevant lines,
    <span class="green"><b>42</b> lines covered</span> and
    <span class="red"><b>91</b> lines missed. </span>
    (<span class="red">
  31.58%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ad654c0d32f54187d9ff082515e25bff345fb4b5" class="src_link" title="app/models/character.rb">app/models/character.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">11</td>
            <td class="cell--number">7</td>
            <td class="cell--number">7</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.71</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5a1396c2ad8dcb2723e5f0ec9c0b9c6c82c05033" class="src_link" title="app/models/invitation.rb">app/models/invitation.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">11</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#bd2892c9577dd72f130feb1e6ebc4e5df10de2ac" class="src_link" title="app/models/matching_game.rb">app/models/matching_game.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">78</td>
            <td class="cell--number">54</td>
            <td class="cell--number">0</td>
            <td class="cell--number">54</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2ab5ea69f5ac590521137fd166e3ea9c59fc4266" class="src_link" title="app/models/square.rb">app/models/square.rb</a></td>
            <td class="red strong cell--number t-file__coverage">45.45 %</td>
            <td class="cell--number">54</td>
            <td class="cell--number">22</td>
            <td class="cell--number">10</td>
            <td class="cell--number">12</td>
            <td class="cell--number">0.91</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#646b5ec673b8862ab13b4639c9b8f7a97beac44f" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">20</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.79</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#7142763a24b9b72e2813bb6fe81293f1b9f422e9" class="src_link" title="app/models/user_world.rb">app/models/user_world.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">14</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f530784403ecd253d3c307afab43db653b927825" class="src_link" title="app/models/world.rb">app/models/world.rb</a></td>
            <td class="red strong cell--number t-file__coverage">64.71 %</td>
            <td class="cell--number">30</td>
            <td class="cell--number">17</td>
            <td class="cell--number">11</td>
            <td class="cell--number">6</td>
            <td class="cell--number">0.94</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Mailers">
  <h2>
    <span class="group_name">Mailers</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Mailers"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Helpers">
  <h2>
    <span class="group_name">Helpers</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Helpers"></a>

  <div>
    <b>1</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>10</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>10</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#402f23aa711eeb1fb182c2ab12ed7d9b6bd60e70" class="src_link" title="app/helpers/squares_helper.rb">app/helpers/squares_helper.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">10</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Jobs">
  <h2>
    <span class="group_name">Jobs</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Jobs"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Libraries">
  <h2>
    <span class="group_name">Libraries</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Libraries"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Views">
  <h2>
    <span class="group_name">Views</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Views"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Ungrouped">
  <h2>
    <span class="group_name">Ungrouped</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Ungrouped"></a>

  <div>
    <b>4</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>148</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>148</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a63af90be4f84f247279104ae8ca657e19d0427e" class="src_link" title="app/services/fake_payment_service.rb">app/services/fake_payment_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">20</td>
            <td class="cell--number">15</td>
            <td class="cell--number">0</td>
            <td class="cell--number">15</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5fd694065847678d86cc57c298f96581bb20fb08" class="src_link" title="app/services/open_exchange_service.rb">app/services/open_exchange_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">24</td>
            <td class="cell--number">21</td>
            <td class="cell--number">0</td>
            <td class="cell--number">21</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5418263317411b8042b0e65f068c80fb6ba99d0f" class="src_link" title="app/services/openai_service.rb">app/services/openai_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">106</td>
            <td class="cell--number">90</td>
            <td class="cell--number">0</td>
            <td class="cell--number">90</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c435cb53ac61b47f2879aa1c55f410c8d9dab8ab" class="src_link" title="app/services/store_service.rb">app/services/store_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">27</td>
            <td class="cell--number">22</td>
            <td class="cell--number">0</td>
            <td class="cell--number">22</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
      </div>

      <div id="footer">
        Generated by <a href="https://github.com/simplecov-ruby/simplecov">simplecov</a> v0.22.0
        and simplecov-html v0.13.1<br/>
        using RSpec
      </div>

      <div class="source_files">
      
        <div class="source_table" id="3c82a75566e01a07b3230a2b7302b4eb768a5acc">
  <div class="header">
    <h3>app/channels/game_channel.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>17</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>17</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class GameChannel &lt; ApplicationCable::Channel</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def subscribed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    stream_from &quot;game_channel_#{params[:world_id]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  def unsubscribed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">    # Any cleanup needed when channel is unsubscribed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  def move(data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    character = Character.find(data[&#39;character_id&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    character.update(x_coord: data[&#39;x&#39;], y_coord: data[&#39;y&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    ActionCable.server.broadcast &quot;game_channel_#{params[:world_id]}&quot;, {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      character_id: character.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      x_coord: data[&#39;x&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      y_coord: data[&#39;y&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      image_code: character.image_code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">end </code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8c6f1f3e33655db143a5e8282346ff40b163613f">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>22</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class ApplicationController &lt; ActionController::Base</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  protect_from_forgery with: :exception</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  skip_before_action :verify_authenticity_token, if: :json_request?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  helper_method :current_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  protected</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  def json_request?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    request.format.json?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">  def current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    @current_user ||= User.find_by(id: session[:user_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">  def set_current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    @current_user ||= User.find_by_session_token(session[:session_token])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    redirect_to login_path unless @current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">  def destroy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    session[:session_token] = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    @current_user = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    flash[:notice] = &#39;You have been logged out&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    redirect_to login_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a7959005965f0a65860e5a319b6635f73e6435da">
  <div class="header">
    <h3>app/controllers/characters_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>57</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>57</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class CharactersController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  before_action :set_character, only: [:save_coordinates, :update_shards]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  before_action :current_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  def save_coordinates</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @character = Character.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    if @character.update(x_coord: params[:x], y_coord: params[:y])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      puts &quot;kkkk#{@character.x_coord}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      puts &quot;kkkk#{@character.y_coord}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      render json: { success: true, message: &#39;Coordinates saved successfully.&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">      render json: { success: false, errors: @character.errors.full_messages }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">  def update_shards</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    character = Character.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    shards_being_bought = params[:shards].to_i</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    price = params[:price].to_f</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    credit_card = {card_number: params[:card_number], cvv: params[:cvv], expiration_date: params[:expiration_date]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    result = FakePaymentService.charge(price, credit_card)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    if result[:status] == &#39;Success&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      character.update!(shards: character.shards + shards_being_bought)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">        success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">        new_shards: character.shards,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">        transaction_id: result[:transaction_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      render json: { success: false, error: result[:error] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">  def new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    @user_world = UserWorld.find(params[:user_world_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    @character = Character.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    @character = Character.new(character_params)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    if @character.save</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      flash[:notice] = &quot;Character created successfully!&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      redirect_to worlds_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">      flash.now[:alert] = &quot;Error creating character.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      render :new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">  def set_character</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    @character = Character.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">  rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    render json: { success: false, message: &#39;Character not found.&#39; }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">  def current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    @current_user ||= User.find_by(id: session[:user_id]) || User.find_by(id: params[:user_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">  def character_params</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">    params.require(:character).permit(:name, :image_code, :user_world_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e2542a02fa49b87ded4b175e9e93d0df73549058">
  <div class="header">
    <h3>app/controllers/invitations_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>66</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>66</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class InvitationsController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    receiver = User.find_by(email: params[:email])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">    world_id = params[:world_id]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    if !receiver</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">      flash.clear</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      flash.now[&#39;alert-danger&#39;] = &quot;User with that email not found.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    elsif receiver == current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      flash.clear</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">      flash.now[&#39;alert-danger&#39;] = &quot;You cannot invite yourself.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    elsif Invitation.exists?(receiver_id: receiver&amp;.id, world_id: world_id, status: [&#39;pending&#39;, &#39;accepted&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      flash.clear</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      flash.now[&#39;alert-danger&#39;] = &quot;You have already invited that player.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      invitation = Invitation.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">        sender_id: current_user.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">        receiver_id: receiver.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">        world_id: world_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">        status: &#39;pending&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      if invitation.save</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">        flash.clear</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">        flash.now[&#39;alert-success&#39;] = &quot;Invitation sent to #{receiver.email}!&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">        flash.clear</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">        flash.now[&#39;alert-danger&#39;] = &quot;Failed to send invitation.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    respond_to do |format|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      format.html { redirect_to worlds_path }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      format.js { render partial: &#39;shared/flash&#39;, locals: { flash: flash } }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">  def accept</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    invitation = Invitation.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    if invitation.receiver == current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      ActiveRecord::Base.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">        invitation.update!(status: &#39;accepted&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">        # Create UserWorld association with default role &#39;player&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">        UserWorld.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">          user: current_user,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">          world: invitation.world,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">          user_role: &#39;player&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">          owner: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      flash[:success] = &quot;Invitation accepted! Please create your character.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">      redirect_to join_world_form_path(user_world_id: UserWorld.last.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">      flash[:danger] = &quot;You are not authorized to accept this invitation.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      redirect_to worlds_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    flash[:danger] = &quot;Failed to accept invitation: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    redirect_to worlds_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">  def decline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    invitation = Invitation.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">    if invitation.receiver == current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">      invitation.update(status: &#39;declined&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      flash[:success] = &quot;Invitation declined.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      flash[:danger] = &quot;You are not authorized to decline this invitation.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    redirect_to worlds_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">end </code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c3424d1968c05f18c2669242ef913dd8a5d1b4d8">
  <div class="header">
    <h3>app/controllers/matching_game_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>32</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>32</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class MatchingGameController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  before_action :load_images, only: [:index, :flip]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">    # Create a new minigame instance each time user is directed to the view</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">    # Use session to store minigame data during each game</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @user ||= User.find_by id: params[:user_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    @world ||= World.find_by id: params[:world_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    @mini_game = MatchingGame.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    session[:mini_game_state] = @mini_game.state</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    @shuffled_cards = @mini_game.cards_idx</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    puts @shuffled_cards</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">  def load_images</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    # Load images 1-5 from the app/assets/images directory</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    # Images are named card_image1.png, card_image2.png, etc.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    @images = (1..5).map {|i| &quot;card_image#{i}.png&quot;}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">  def flip</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    # Get the current state of the minigame</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    @mini_game = MatchingGame.new(session[:mini_game_state])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    puts @mini_game.inspect</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    # Check for the case that minigame was not properly instantiated</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    return render json: {error: &quot;Failed to generate and set new mini game.&quot;}, status: :unprocessable_entity if @mini_game.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    # Otherwise, call model&#39;s flip_card method to handle flipping of a card</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    # Get the index of the flipped card from the parameters and convert to an integer</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    card_idx = params[:index].to_i</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">    # Flip the card and get the resulting state of the game</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    result = @mini_game.flip_card(card_idx)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    # Update game session</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    session[:mini_game_state] = @mini_game.state</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">    # Check if the user has matched all cards and the game is over</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    game_status = @mini_game.game_over?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">    # Build the response JSON with necessary information</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    response = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      card: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">        index: card_idx,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        image: @images[card_idx]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      result: result,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">      game_status: game_status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">    # Return the JSON response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    render json: response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="938b2467ba981791d886f2d5bf23ecca747c6cec">
  <div class="header">
    <h3>app/controllers/sessions_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>20</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>20</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class SessionsController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    user = User.find_by(email: params[:email])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    if user&amp;.authenticate(params[:password])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      session[:session_token] = user.session_token</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      session[:user_id] = user.id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      @current_user = user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">      redirect_to worlds_path(user_id: user.id), notice: &#39;Logged in successfully!&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      flash.now[:warning] = &#39;Invalid email or password&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      render &#39;new&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">  def destroy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    session[:session_token] = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    redirect_to root_path, notice: &#39;Logged out successfully!&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="034fc7a4eedf1f1e76ebd5fafab28d4b20814b7a">
  <div class="header">
    <h3>app/controllers/settings_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>32</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>32</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class SettingsController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  before_action :current_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def show</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @user = @current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @currencies = OpenExchangeService.fetch_currencies</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    session[:return_path] = params[:return_path] if params[:return_path]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  def update</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    previous_session_token = @current_user.session_token</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    if @current_user.update(default_currency: params[:currency])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      @current_user.update_column(:session_token, previous_session_token)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      @prices = StoreService.fetch_prices(@current_user.default_currency)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      flash[:notice] = &#39;Settings saved successfully!&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      puts &quot;Flash message set: #{flash[:notice]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      redirect_to settings_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      Rails.logger.error &quot;Update failed: #{current_user.errors.full_messages}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      flash[:alert] = &#39;Could not save settings.&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">  def character_picture_url(role)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      &#39;Captain&#39; =&gt; &#39;1_1_1.png&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      &#39;Navigator&#39; =&gt; &#39;1_2_2.png&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      &#39;Crew Member&#39; =&gt; &#39;1_3_3.png&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    }[role] || &#39;1_1_1.png&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">  def current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    @current_user ||= User.find_by(id: session[:user_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="fe4145bb4243f300b228bb5a7084938aaf8db60b">
  <div class="header">
    <h3>app/controllers/squares_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>117</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>117</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class SquaresController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  def landing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">    store</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @user ||= User.find_by id: params[:user_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @world ||= World.find_by id: params[:world_id]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    unless @world</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      flash[:alert] = &quot;No world selected&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      redirect_to worlds_path and return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    @world_id = @world&amp;.id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    @squares = Square.where(world_id: @world.id).order(:y, :x)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    @character ||= @world.characters.find_by(user_id: @user.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    @game_result = params[:game_result] || false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">  def pay_shards</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    @character = Character.find_by(id: params[:character_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    @square = Square.find_by(square_id: params[:square_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    if !@character || !@square</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">        success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">        message: &quot;Invalid square/character&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    row_difference = (@square.y - @character.y_coord).abs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    column_difference = (@square.x - @character.x_coord).abs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    shards_cost_for_teleporting = row_difference + column_difference</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    if @square.state == &quot;inactive&quot; &amp;&amp; @character.shards &gt;= 10</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      # Deduct shards and generate terrain</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      Square.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">        @character.update!(shards: @character.shards - 10)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">        # Generate terrain</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">        terrain_types = [&quot;forest&quot;, &quot;desert&quot;, &quot;water&quot;, &quot;plains&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">        terrain = terrain_types.sample</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">        # Get adjacent squares for context</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        adjacent_squares = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">          north: Square.find_by(world_id: @square.world_id, x: @square.x, y: @square.y - 1)&amp;.terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">          south: Square.find_by(world_id: @square.world_id, x: @square.x, y: @square.y + 1)&amp;.terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">          east: Square.find_by(world_id: @square.world_id, x: @square.x + 1, y: @square.y)&amp;.terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">          west: Square.find_by(world_id: @square.world_id, x: @square.x - 1, y: @square.y)&amp;.terrain</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">        # Generate code using OpenAI</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">        generated_code = OpenaiService.generate_terrain_code(terrain, adjacent_squares)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">        @square.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">          state: &#39;active&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">          terrain: terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">          code: generated_code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">          success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">          game_result: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">          new_shards: @character.shards,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">          square: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">            id: @square.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">            code: generated_code,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">            terrain_type: terrain</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    elsif @square.state == &quot;active&quot; &amp;&amp; @character.shards &gt;= shards_cost_for_teleporting</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      Square.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">        @character.update!(shards: @character.shards - shards_cost_for_teleporting)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">          success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">          game_result: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">          new_shards: @character.shards,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">          square: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">            id: @square.id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">        success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">        message: &quot;Not enough shards&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">      }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">  def activate_square</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">    @square = Square.find_by(square_id: params[:square_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">    @character = Character.find(params[:character_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    if @square.activate_square(@character)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">        success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">        message: &quot;Square activated successfully!&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">        new_shards: @character.shards,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">        square: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">          id: @square.square_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">          code: @square.code,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">          terrain_type: @square.terrain_type</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">        success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">        message: &quot;Failed to activate square. Make sure you have enough shards.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">      }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">  def generate_square_code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">    x = params[:x]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">    y = params[:y]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">    # Generate terrain code here</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">    terrain_types = [&quot;forest&quot;, &quot;desert&quot;, &quot;water&quot;, &quot;plains&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">    terrain = terrain_types.sample</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">    # You can implement your own terrain generation logic here</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">    code = &quot;ctx.fillStyle = &#39;#eee&#39;; ctx.fillRect(0, 0, 105, 105);&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">    render json: { success: true, code: code }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">    render json: { success: false, error: e.message }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">  def store</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">    @user = current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">    @currency = @user.default_currency || &#39;USD&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">    @prices = StoreService.fetch_prices(@user.default_currency)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">    puts &quot;User: #{@user}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">    puts &quot;Currency: #{@currency}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">    puts &quot;Prices: #{@prices}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">  def current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">    @current_user ||= User.find_by id: params[:user_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8624b070422e76f4aa14fff46547d0d497f69cb1">
  <div class="header">
    <h3>app/controllers/users_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>21</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>21</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class UsersController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  before_action :set_current_user, :only=&gt;[&#39;show&#39;, &#39;edit&#39;, &#39;update&#39;, &#39;delete&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @user = User.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Parameters received: #{params.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    @user = User.new(user_params)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    if @user.save</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      flash[:notice] = &quot;Successfully created account!&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      redirect_to login_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      flash.now[:alert] = &quot;Error: #{@user.errors.full_messages.join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      render :new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">  def user_params</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    puts params</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    params.require(:user).permit(:name, :email, :password, :password_confirmation)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1a94853ca1151736bcd3878fb64ff1e95f6788a2">
  <div class="header">
    <h3>app/controllers/worlds_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>422</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>422</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class WorldsController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  before_action :current_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @world_id = params[:world_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @user_world_id = params[:user_world_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    if @current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">      @user_worlds = @current_user.user_worlds</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">      @invitations = Invitation.where(receiver_id: @current_user.id, status: &#39;pending&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      @invited_players = {}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      @user_worlds.each do |user_world|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">        world = user_world.world</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">        # Get all invitations for this world, excluding accepted ones and getting unique emails</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">        @invited_players[world.id] = Invitation.where(world_id: world.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">                                           .where.not(status: &#39;accepted&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">                                           .includes(:receiver)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">                                           .map { |invitation| invitation.receiver.email }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">                                           .uniq</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      @world = @user_worlds.first&amp;.world</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      flash[:alert] = &#39;Please log in to view your worlds.&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      redirect_to login_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    puts &quot;Form submitted successfully!&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    if params[:user_world_id].present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      # Handle invited user character creation</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      @user_world = UserWorld.find(params[:user_world_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      @image_path = &quot;#{params[:gender]}_#{params[:preload]}_#{params[:role]}.png&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      Character.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">        world: @user_world.world,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">        user: @current_user,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">        shards: 10,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">        x_coord: 175,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">        y_coord: 30,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        image_code: @image_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">      # Handle new world creation</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">      @world = World.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">        last_played: DateTime.now,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">        progress: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">        world_name: params[:world_name]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      if @world.save</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">        @image_path = &quot;#{params[:gender]}_#{params[:preload]}_#{params[:role]}.png&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">        UserWorld.create!(user: @current_user, world: @world, user_role: params[:role], owner: true)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">        Character.create!(world: @world, user: @current_user, shards: 10, x_coord: 0, y_coord: 0, image_code: @image_path)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">        generate_squares_for_world(@world)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">    flash[:notice] = &quot;Character created successfully!&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    redirect_to worlds_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">  def destroy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    @user_world = UserWorld.find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    @world = World.find_by(id: @user_world.world_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    if @user_world.owner</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">      UserWorld.where(world_id: @world.id).destroy_all</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">      @world.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">      flash[:notice] = &quot;World &#39;#{@world.world_id}&#39; deleted.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      @user_world.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">      flash[:notice] = &quot;World &#39;#{@world.world_id}&#39; removed.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    redirect_to worlds_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">  def start_game</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">    @world = World.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">    @squares = @world.squares.order(:y, :x)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">    store</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    @user = current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    @user_world = UserWorld.find_by(user_id: @user.id, world_id: @world.id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">    # Find the specific character for this user in this world</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">    @character = @world.characters.find_by(user_id: @user.id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">    if @squares.count != 36</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">      flash[:alert] = &quot;Regenerating squares for this world&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">      @squares.destroy_all</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">      generate_squares_for_world(@world)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">      @squares = @world.squares.reload.order(:y, :x)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">    redirect_to landing_path(world_id: @world.id, user_id: @user.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">  def generate_square_code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">    x = params[:x].to_i</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">    y = params[:y].to_i</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">    terrain_types = [&quot;desert&quot;, &quot;water&quot;, &quot;forest&quot;, &quot;plains&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">    terrain = terrain_types.sample</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">      square = @world.squares.find_or_initialize_by(x: x, y: y)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">      adjacent_terrains = get_adjacent_terrains(@world, x, y)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">      code = OpenaiService.generate_terrain_code(terrain, adjacent_terrains)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">      if code.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">        square.update!(terrain: terrain, code: code)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">        render json: { success: true, code: code, terrain: terrain }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">        render json: { success: false, error: &quot;Failed to generate terrain code&quot; }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">      Rails.logger.error(&quot;Validation error: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">      render json: { success: false, error: &quot;Validation error: #{e.message}&quot; }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">    rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">      Rails.logger.error(&quot;Error in generate_square_code: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">      render json: { success: false, error: &quot;Error generating terrain: #{e.message}&quot; }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">  def join</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">    @user_world_id = params[:user_world_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">  def join_existing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">    @user_world = UserWorld.find(params[:user_world_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">    @image_path = &quot;#{params[:gender]}_#{params[:preload]}_#{params[:role]}.png&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">    Character.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">      world: @user_world.world,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">      user: current_user,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">      shards: 10,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">      x_coord: 175,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">      y_coord: 30,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">      image_code: @image_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">    flash[:notice] = &quot;Character created successfully!&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">    redirect_to worlds_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">  def pay_shards</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">    @character = Character.find_by(id: params[:character_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">    @square = Square.find_by(square_id: params[:square_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">    if !@character || !@square</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">        success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">        message: &quot;Invalid square/character&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">      }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">    row_difference = (@square.y - @character.y_coord).abs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">    column_difference = (@square.x - @character.x_coord).abs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">    shards_cost_for_teleporting = row_difference + column_difference</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">    if @square.state == &quot;inactive&quot; &amp;&amp; @character.shards &gt;= 10</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby">      # Deduct shards and generate terrain</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">      Square.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">        @character.update!(shards: @character.shards - 10)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">        # Generate terrain</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">        terrain_types = [&quot;forest&quot;, &quot;desert&quot;, &quot;water&quot;, &quot;plains&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">        terrain = terrain_types.sample</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">        # Get adjacent squares for context</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">        adjacent_squares = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">          north: Square.find_by(world_id: @square.world_id, x: @square.x, y: @square.y - 1)&amp;.terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">          south: Square.find_by(world_id: @square.world_id, x: @square.x, y: @square.y + 1)&amp;.terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">          east: Square.find_by(world_id: @square.world_id, x: @square.x + 1, y: @square.y)&amp;.terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">          west: Square.find_by(world_id: @square.world_id, x: @square.x - 1, y: @square.y)&amp;.terrain</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">        # Generate code using OpenAI</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="183">
            

            

            <code class="ruby">        generated_code = OpenaiService.generate_terrain_code(terrain, adjacent_squares)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">        @square.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">          state: &#39;active&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">          terrain: terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">          code: generated_code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">          success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">          game_result: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">          new_shards: @character.shards,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">          square: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">            id: @square.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">            code: generated_code,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">            terrain_type: terrain</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="199">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">    elsif @square.state == &quot;active&quot; &amp;&amp; @character.shards &gt;= shards_cost_for_teleporting</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">      Square.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">        @character.update!(shards: @character.shards - shards_cost_for_teleporting)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">          success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">          game_result: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">          new_shards: @character.shards,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="209">
            

            

            <code class="ruby">          square: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="210">
            

            

            <code class="ruby">            id: @square.id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">        success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">        message: &quot;Not enough shards&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">      }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="220">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="221">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="222">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="223">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">  def generate_squares_for_world(world)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="225">
            

            

            <code class="ruby">    # Define available terrains</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">    terrain_types = [&quot;desert&quot;, &quot;water&quot;, &quot;forest&quot;, &quot;plains&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">    js_functions = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="229">
            

            

            <code class="ruby">    # Define the initial three squares in the top-left corner</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="230">
            

            

            <code class="ruby">    active_positions = [[0, 0], [1, 0], [0, 1]]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="231">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            

            <code class="ruby">    # Generate the initial three squares with random terrains</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="233">
            

            

            <code class="ruby">    active_positions.each do |x, y|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="234">
            

            

            <code class="ruby">      # Get random terrain type</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">      terrain = terrain_types.sample</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="236">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            

            

            <code class="ruby">      # Get adjacent terrains for context</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">      adjacent_terrains = get_adjacent_terrains(world, x, y)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="239">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="240">
            

            

            <code class="ruby">      # Generate terrain code with context</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">      drawing_commands = OpenaiService.generate_terrain_code(terrain, adjacent_terrains)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="242">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            

            <code class="ruby">      # Create the function code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="244">
            

            

            <code class="ruby">      function_code = &lt;&lt;~JAVASCRIPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">        function drawSquare_#{x}_#{y}(containerId) {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">          const canvas = document.createElement(&#39;canvas&#39;);</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">          canvas.width = 105;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="248">
            

            

            <code class="ruby">          canvas.height = 105;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">          const ctx = canvas.getContext(&#39;2d&#39;);</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="250">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="251">
            

            

            <code class="ruby">          #{drawing_commands}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="252">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">          document.getElementById(containerId).appendChild(canvas);</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="254">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="255">
            

            

            <code class="ruby">      JAVASCRIPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="256">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="257">
            

            

            <code class="ruby">      js_functions &lt;&lt; function_code</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="259">
            

            

            <code class="ruby">      # Create the square with the generated code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="260">
            

            

            <code class="ruby">      world.squares.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="261">
            

            

            <code class="ruby">        square_id: SecureRandom.hex(10),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="262">
            

            

            <code class="ruby">        world_id: world.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">        x: x,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="264">
            

            

            <code class="ruby">        y: y,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="265">
            

            

            <code class="ruby">        state: &quot;active&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">        terrain: terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="267">
            

            

            <code class="ruby">        code: drawing_commands</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="269">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="270">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="271">
            

            

            <code class="ruby">    # Create the rest of the grid without code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="272">
            

            

            <code class="ruby">    6.times do |y|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">      6.times do |x|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="274">
            

            

            <code class="ruby">        next if active_positions.include?([x, y])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="275">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="276">
            

            

            <code class="ruby">        world.squares.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="277">
            

            

            <code class="ruby">          square_id: SecureRandom.hex(10),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="278">
            

            

            <code class="ruby">          world_id: world.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="279">
            

            

            <code class="ruby">          x: x,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="280">
            

            

            <code class="ruby">          y: y,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="281">
            

            

            <code class="ruby">          state: &quot;inactive&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="282">
            

            

            <code class="ruby">          terrain: &quot;empty&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="283">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="284">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="285">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="286">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="287">
            

            

            <code class="ruby">    # Add a script tag to define all functions at once</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="288">
            

            

            <code class="ruby">    script_tag = &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="289">
            

            

            <code class="ruby">      &lt;script&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="290">
            

            

            <code class="ruby">        #{js_functions.join(&quot;\n\n&quot;)}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="291">
            

            

            <code class="ruby">      &lt;/script&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="292">
            

            

            <code class="ruby">    HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="293">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="294">
            

            

            <code class="ruby">    # Store the script tag in a place where your view can access it</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="295">
            

            

            <code class="ruby">    @js_functions = script_tag</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="296">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="297">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="298">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="299">
            

            

            <code class="ruby">  def generate_terrain_map(width, height)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="300">
            

            

            <code class="ruby">    terrain_types = [&quot;desert&quot;, &quot;lake&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="301">
            

            

            <code class="ruby">    map = Array.new(6) { Array.new(6, &quot;lake&quot;) }  # Start with lake as base terrain</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="302">
            

            

            <code class="ruby">    total_squares = width * height</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="303">
            

            

            <code class="ruby">    max_desert_squares = (total_squares * 0.25).floor  # Maximum 25% desert tiles</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="304">
            

            

            <code class="ruby">    desert_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="305">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="306">
            

            

            <code class="ruby">    # Helper function to count adjacent desert tiles</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="307">
            

            

            <code class="ruby">    def count_adjacent_desert(map, x, y)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="308">
            

            

            <code class="ruby">      count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="309">
            

            

            <code class="ruby">      # Check all 8 adjacent squares</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="310">
            

            

            <code class="ruby">      [[-1,-1], [-1,0], [-1,1], [0,-1], [0,1], [1,-1], [1,0], [1,1]].each do |dx, dy|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="311">
            

            

            <code class="ruby">        check_x = x + dx</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="312">
            

            

            <code class="ruby">        check_y = y + dy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="313">
            

            

            <code class="ruby">        if check_x.between?(0, 5) &amp;&amp; check_y.between?(0, 5)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="314">
            

            

            <code class="ruby">          count += 1 if map[check_y][check_x] == &quot;desert&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="315">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="316">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="317">
            

            

            <code class="ruby">      count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="318">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="319">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="320">
            

            

            <code class="ruby">    # Helper function to check if adding desert would create too many adjacent deserts</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="321">
            

            

            <code class="ruby">    def would_create_too_many_adjacent?(map, x, y)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="322">
            

            

            <code class="ruby">      # First check the proposed position</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="323">
            

            

            <code class="ruby">      return true if count_adjacent_desert(map, x, y) &gt;= 3</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="324">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="325">
            

            

            <code class="ruby">      # Then check all adjacent positions to ensure we won&#39;t create too many</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="326">
            

            

            <code class="ruby">      [[-1,-1], [-1,0], [-1,1], [0,-1], [0,1], [1,-1], [1,0], [1,1]].each do |dx, dy|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="327">
            

            

            <code class="ruby">        check_x = x + dx</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="328">
            

            

            <code class="ruby">        check_y = y + dy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="329">
            

            

            <code class="ruby">        if check_x.between?(0, 5) &amp;&amp; check_y.between?(0, 5)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="330">
            

            

            <code class="ruby">          # Temporarily add the desert and check</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="331">
            

            

            <code class="ruby">          map[y][x] = &quot;desert&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="332">
            

            

            <code class="ruby">          too_many = count_adjacent_desert(map, check_x, check_y) &gt; 3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="333">
            

            

            <code class="ruby">          map[y][x] = &quot;lake&quot;  # Reset</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="334">
            

            

            <code class="ruby">          return true if too_many</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="335">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="336">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="337">
            

            

            <code class="ruby">      false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="338">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="339">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="340">
            

            

            <code class="ruby">    # Helper function to check if a position is valid for an island</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="341">
            

            

            <code class="ruby">    def is_valid_island_position?(map, x, y, width, height)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="342">
            

            

            <code class="ruby">      return false if x &lt; 0 || x &gt;= width || y &lt; 0 || y &gt;= height</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="343">
            

            

            <code class="ruby">      return false if map[y][x] != &quot;lake&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="344">
            

            

            <code class="ruby">      return false if would_create_too_many_adjacent?(map, x, y)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="345">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="346">
            

            

            <code class="ruby">      # Check immediate neighbors for spacing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="347">
            

            

            <code class="ruby">      [[-1,0], [1,0], [0,-1], [0,1]].each do |dx, dy|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="348">
            

            

            <code class="ruby">        check_x = x + dx</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="349">
            

            

            <code class="ruby">        check_y = y + dy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="350">
            

            

            <code class="ruby">        if check_x.between?(0, width-1) &amp;&amp; check_y.between?(0, height-1)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="351">
            

            

            <code class="ruby">          return false if map[check_y][check_x] != &quot;lake&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="352">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="353">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="354">
            

            

            <code class="ruby">      true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="355">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="356">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="357">
            

            

            <code class="ruby">    # Create 4-5 desert islands (well-spaced, max 3 adjacent)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="358">
            

            

            <code class="ruby">    5.times do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="359">
            

            

            <code class="ruby">      break if desert_count &gt;= max_desert_squares</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="360">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="361">
            

            

            <code class="ruby">      attempts = 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="362">
            

            

            <code class="ruby">      while attempts &lt; 30</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="363">
            

            

            <code class="ruby">        x = rand(width)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="364">
            

            

            <code class="ruby">        y = rand(height)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="365">
            

            

            <code class="ruby">        if is_valid_island_position?(map, x, y, width, height)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="366">
            

            

            <code class="ruby">          map[y][x] = &quot;desert&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="367">
            

            

            <code class="ruby">          desert_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="368">
            

            

            <code class="ruby">          break</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="369">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="370">
            

            

            <code class="ruby">        attempts += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="371">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="372">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="373">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="374">
            

            

            <code class="ruby">    map</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="375">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="376">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="377">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="378">
            

            

            <code class="ruby">  def generate_fallback_code(x, y, terrain)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="379">
            

            

            <code class="ruby">    &lt;&lt;~JAVASCRIPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="380">
            

            

            <code class="ruby">      function drawSquare_#{x}_#{y}(containerId) {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="381">
            

            

            <code class="ruby">        const canvas = document.createElement(&#39;canvas&#39;);</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="382">
            

            

            <code class="ruby">        canvas.width = 105;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="383">
            

            

            <code class="ruby">        canvas.height = 105;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="384">
            

            

            <code class="ruby">        const ctx = canvas.getContext(&#39;2d&#39;);</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="385">
            

            

            <code class="ruby">        ctx.fillStyle = &#39;#{</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="386">
            

            

            <code class="ruby">      case terrain</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="387">
            

            

            <code class="ruby">      when &quot;lake&quot; then &quot;#4444FF&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="388">
            

            

            <code class="ruby">      when &quot;forest&quot; then &quot;#44FF44&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="389">
            

            

            <code class="ruby">      when &quot;mountain&quot; then &quot;#8B4513&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="390">
            

            

            <code class="ruby">      when &quot;village&quot; then &quot;#808080&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="391">
            

            

            <code class="ruby">      when &quot;plain&quot; then &quot;#FFFF44&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="392">
            

            

            <code class="ruby">      else &quot;#F4A460&quot; # desert</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="393">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="394">
            

            

            <code class="ruby">    }&#39;;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="395">
            

            

            <code class="ruby">        ctx.fillRect(0, 0, 105, 105);</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="396">
            

            

            <code class="ruby">        document.getElementById(containerId).appendChild(canvas);</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="397">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="398">
            

            

            <code class="ruby">    JAVASCRIPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="399">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="400">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="401">
            

            

            <code class="ruby">  def generate_single_square(world, x, y, terrain, client)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="402">
            

            

            <code class="ruby">    return if world.squares.exists?(x: x, y: y)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="403">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="404">
            

            

            <code class="ruby">    adjacent_terrains = get_adjacent_terrains(world, x, y)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="405">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="406">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="407">
            

            

            <code class="ruby">      response = client.chat(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="408">
            

            

            <code class="ruby">        parameters: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="409">
            

            

            <code class="ruby">          model: &quot;gpt-3.5-turbo&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="410">
            

            

            <code class="ruby">          messages: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="411">
            

            

            <code class="ruby">            {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="412">
            

            

            <code class="ruby">              role: &quot;system&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="413">
            

            

            <code class="ruby">              content: &quot;You are a JavaScript canvas expert creating a minimalist ocean with small sandy desert islands. EVERY water tile must be EXACTLY identical.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="414">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="415">
            

            

            <code class="ruby">              OCEAN BACKGROUND:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="416">
            

            

            <code class="ruby">              - Fill ENTIRE canvas with EXACTLY #1E90FF</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="417">
            

            

            <code class="ruby">              - Every single water tile must be identical</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="418">
            

            

            <code class="ruby">              - NO variation in the blue color</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="419">
            

            

            <code class="ruby">              - NO patterns or lines</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="420">
            

            

            <code class="ruby">              - Just solid blue color</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="421">
            

            

            <code class="ruby">              </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="422">
            

            

            <code class="ruby">              DESERT ISLANDS (when present):</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="423">
            

            

            <code class="ruby">              - Color: Muted sandy tan (#D2B48C)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="424">
            

            

            <code class="ruby">              - Single small organic shape with curved edges</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="425">
            

            

            <code class="ruby">              - Must take up only 20-40% of tile maximum</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="426">
            

            

            <code class="ruby">              - NO straight lines or edges anywhere</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="427">
            

            

            <code class="ruby">              - Edges must be smooth bezier curves</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="428">
            

            

            <code class="ruby">              - Natural, irregular island shapes</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="429">
            

            

            <code class="ruby">              - Must be surrounded by water</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="430">
            

            

            <code class="ruby">              </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="431">
            

            

            <code class="ruby">              CRITICAL RULES:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="432">
            

            

            <code class="ruby">              1. EVERY water tile must be pure #1E90FF only</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="433">
            

            

            <code class="ruby">              2. Desert must take up LESS than 40% of any tile</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="434">
            

            

            <code class="ruby">              3. NO straight lines in island shapes</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="435">
            

            

            <code class="ruby">              4. Islands must have only curved boundaries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="436">
            

            

            <code class="ruby">              5. Perfect alignment between adjacent tiles</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="437">
            

            

            <code class="ruby">              6. Water must be completely solid color</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="438">
            

            

            <code class="ruby">              7. NO variation in background color</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="439">
            

            

            <code class="ruby">              8. Islands must be small and well-spaced&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="440">
            

            

            <code class="ruby">            },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="441">
            

            

            <code class="ruby">            {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="442">
            

            

            <code class="ruby">              role: &quot;user&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="443">
            

            

            <code class="ruby">              content: &quot;Generate JavaScript code for a #{terrain} tile (105x105 canvas) that connects with:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="444">
            

            

            <code class="ruby">              North: #{adjacent_terrains[:north] || &#39;unknown&#39;}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="445">
            

            

            <code class="ruby">              South: #{adjacent_terrains[:south] || &#39;unknown&#39;}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="446">
            

            

            <code class="ruby">              East: #{adjacent_terrains[:east] || &#39;unknown&#39;}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="447">
            

            

            <code class="ruby">              West: #{adjacent_terrains[:west] || &#39;unknown&#39;}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="448">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="449">
            

            

            <code class="ruby">                </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="450">
            

            

            <code class="ruby">                Use only the &#39;ctx&#39; variable. The terrain should be part of a larger #{terrain} feature and blend naturally with adjacent tiles.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="451">
            

            

            <code class="ruby">                </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="452">
            

            

            <code class="ruby">                Ensure features align at edges and maintain consistent style across tiles.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="453">
            

            

            <code class="ruby">                </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="454">
            

            

            <code class="ruby">                Do not create a new canvas or append elements, canvas is already created. Make sure to add all parantheses ) after argument list, do not put in any explanations or comments. Only output the code.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="455">
            

            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="456">
            

            

            <code class="ruby">          ],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="457">
            

            

            <code class="ruby">          temperature: 0.7</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="458">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="459">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="460">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="461">
            

            

            <code class="ruby">      raw_code = response.dig(&#39;choices&#39;, 0, &#39;message&#39;, &#39;content&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="462">
            

            

            <code class="ruby">      sanitized_code = raw_code.gsub(/```(javascript|js)?\n?/, &#39;&#39;).gsub(/```/, &#39;&#39;).gsub(/const ctx = canvas\.getContext\(&#39;2d&#39;\);/, &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="463">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="464">
            

            

            <code class="ruby">      function_name = &quot;drawSquare_#{x}_#{y}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="465">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="466">
            

            

            <code class="ruby">      formatted_code = &lt;&lt;~JAVASCRIPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="467">
            

            

            <code class="ruby">          function #{function_name}(containerId) {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="468">
            

            

            <code class="ruby">            const canvas = document.createElement(&#39;canvas&#39;);</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="469">
            

            

            <code class="ruby">            canvas.width = 105;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="470">
            

            

            <code class="ruby">            canvas.height = 105;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="471">
            

            

            <code class="ruby">            const ctx = canvas.getContext(&#39;2d&#39;);</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="472">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="473">
            

            

            <code class="ruby">            #{sanitized_code}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="474">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="475">
            

            

            <code class="ruby">            document.getElementById(containerId).appendChild(canvas);</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="476">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="477">
            

            

            <code class="ruby">        JAVASCRIPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="478">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="479">
            

            

            <code class="ruby">      # Create square with explicit world association</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="480">
            

            

            <code class="ruby">      world.squares.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="481">
            

            

            <code class="ruby">        square_id: SecureRandom.hex(10),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="482">
            

            

            <code class="ruby">        world_id: world.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="483">
            

            

            <code class="ruby">        x: x,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="484">
            

            

            <code class="ruby">        y: y,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="485">
            

            

            <code class="ruby">        state: &quot;inactive&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="486">
            

            

            <code class="ruby">        terrain: terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="487">
            

            

            <code class="ruby">        code: formatted_code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="488">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="489">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="490">
            

            

            <code class="ruby">      puts &quot;Error generating square: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="491">
            

            

            <code class="ruby">      unless world.squares.exists?(x: x, y: y)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="492">
            

            

            <code class="ruby">        world.squares.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="493">
            

            

            <code class="ruby">          square_id: SecureRandom.hex(10),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="494">
            

            

            <code class="ruby">          world_id: world.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="495">
            

            

            <code class="ruby">          x: x,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="496">
            

            

            <code class="ruby">          y: y,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="497">
            

            

            <code class="ruby">          state: &quot;inactive&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="498">
            

            

            <code class="ruby">          terrain: terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="499">
            

            

            <code class="ruby">          code: generate_fallback_code(x, y, terrain)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="500">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="501">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="502">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="503">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="504">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="505">
            

            

            <code class="ruby">  def get_adjacent_terrains(world, x, y)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="506">
            

            

            <code class="ruby">    return {} unless world.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="507">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="508">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="509">
            

            

            <code class="ruby">      north: world.squares.find_by(x: x, y: y - 1)&amp;.terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="510">
            

            

            <code class="ruby">      south: world.squares.find_by(x: x, y: y + 1)&amp;.terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="511">
            

            

            <code class="ruby">      east: world.squares.find_by(x: x + 1, y: y)&amp;.terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="512">
            

            

            <code class="ruby">      west: world.squares.find_by(x: x - 1, y: y)&amp;.terrain</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="513">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="514">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="515">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="516">
            

            

            <code class="ruby">  def api_call</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="517">
            

            

            <code class="ruby">    client = OpenAI::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="518">
            

            

            <code class="ruby">      access_token: &quot;access_token_goes_here&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="519">
            

            

            <code class="ruby">      log_errors: true # Highly recommended in development, so you can see what errors OpenAI is returning. Not recommended in production because it could leak private data to your logs.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="520">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="521">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="522">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="523">
            

            

            <code class="ruby">  def store</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="524">
            

            

            <code class="ruby">    @user = current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="525">
            

            

            <code class="ruby">    @currency = @user.default_currency || &#39;USD&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="526">
            

            

            <code class="ruby">    puts &quot;USER: #{@user}\nCURRENCY: #{@currency}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="527">
            

            

            <code class="ruby">    @prices = StoreService.fetch_prices(@currency)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="528">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="529">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="530">
            

            

            <code class="ruby">  def current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="531">
            

            

            <code class="ruby">    @current_user ||= User.find_by id: session[:user_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="532">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="533">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="402f23aa711eeb1fb182c2ab12ed7d9b6bd60e70">
  <div class="header">
    <h3>app/helpers/squares_helper.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>10</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">module SquaresHelper</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">    def pixel_class(char)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">      case char</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">      when &#39;~&#39; then &#39;water&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">      when &#39;#&#39; then &#39;land&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">      when &#39;.&#39; then &#39;sand&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">      else &#39;default&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  end  </code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ad654c0d32f54187d9ff082515e25bff345fb4b5">
  <div class="header">
    <h3>app/models/character.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>7</b> relevant lines.
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Character &lt; ActiveRecord::Base</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_create :generate_unique_character_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def generate_unique_character_id</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="6">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    self.character_id = SecureRandom.hex(10) # Generates a 20-character hex string</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :world</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5a1396c2ad8dcb2723e5f0ec9c0b9c6c82c05033">
  <div class="header">
    <h3>app/models/invitation.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>10</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Invitation &lt; ActiveRecord::Base</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  belongs_to :sender, class_name: &#39;User&#39;, foreign_key: &#39;sender_id&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  belongs_to :receiver, class_name: &#39;User&#39;, foreign_key: &#39;receiver_id&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  belongs_to :world</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  validates :receiver_id, uniqueness: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    scope: [:world_id, :status],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    conditions: -&gt; { where(status: [&#39;pending&#39;, &#39;accepted&#39;]) },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    message: &#39;has already been invited to this world&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="bd2892c9577dd72f130feb1e6ebc4e5df10de2ac">
  <div class="header">
    <h3>app/models/matching_game.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>54</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>54</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class MatchingGame</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  attr_reader :cards_idx, :flipped_cards, :matches_idx</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def state</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">      cards_idx: @cards_idx,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">      flipped_cards: @flipped_cards,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      matches_idx: @matches_idx</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  def initialize(state = nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    if state</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      @cards_idx = state[:cards_idx]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      @flipped_cards = state[:flipped_cards]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      @matches_idx = state[:matches_idx]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      @cards_idx = [0, 0, 1, 1, 2, 2, 3, 3, 4, 4].shuffle  # index of the image that will show when card flips</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      @flipped_cards = []   # stores the indicies of the cards the user has flipped, can only flip 2</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      @matches_idx = []     # stores what images have been successfully matched by the user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">  def flip_card(idx)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    # First check if the card is already flipped or matched</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    return {status: &#39;invalid&#39;, reason: &#39;already flipped or matched&#39;} if @flipped_cards.include?(idx) || @matches_idx.flatten.include?(idx)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    puts &quot;Flipping card &quot; + idx.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    puts &quot;Before concatenation: &quot; + @flipped_cards.inspect</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">    # If not, add the index to flipped_cards</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    @flipped_cards.push(idx)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    puts @flipped_cards.inspect</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    # If user has flipped 2 cards, check if they match, otherwise do nothing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    if @flipped_cards.length == 2</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">      # Check if the cards are a match</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      puts &quot;In length = 2&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">      if @cards_idx[@flipped_cards[0]] == @cards_idx[@flipped_cards[1]]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">        # Add that index to the array of matches the user has made</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">        @matches_idx &lt;&lt; [@flipped_cards[0], @flipped_cards[1]]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">        matched = true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">        matched = false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">      # Reset flipped cards</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      @flipped_cards = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">      return {status: &#39;flipped&#39;, matched: matched}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    {status: &#39;flipped&#39;, matched: nil}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">  def game_over?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">    @matches_idx.length == @cards_idx.length / 2</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">  # Helper function for RSpec tests</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">  def get_matches</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    matched_pairs = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">    # Go through each card index</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    @cards_idx.each_with_index do |card_idx1, index1|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">      # Take a slice of the array from index1 + 1 so as to not include the index the first each block is on</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">      # This prevents duplicate matches from showing up in matched_pairs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      @cards_idx[(index1 + 1)..-1].each_with_index do |card_idx2, index2|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">        if card_idx1 == card_idx2</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">          matched_pairs &lt;&lt; [index1, index1 + index2 + 1]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    # Return the indicies of the matching cards</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    matched_pairs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2ab5ea69f5ac590521137fd166e3ea9c59fc4266">
  <div class="header">
    <h3>app/models/square.rb</h3>
    <h4>
      <span class="red">
  45.45%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>22</b> relevant lines.
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>12</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Square &lt; ActiveRecord::Base</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :world</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_create :generate_unique_square_id</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_save :ensure_single_treasure</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def activate_square(character)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    return false unless character.shards &gt;= 10</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">      # Deduct shards from character</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">      character.update!(shards: character.shards - 10)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">      # Generate terrain and code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      terrain_types = [&quot;forest&quot;, &quot;desert&quot;, &quot;water&quot;, &quot;plains&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      terrain = terrain_types.sample</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">      # Get adjacent squares&#39; terrain for context</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">      adjacent_squares = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">        north: world.squares.find_by(x: x, y: y - 1)&amp;.terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">        south: world.squares.find_by(x: x, y: y + 1)&amp;.terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">        east: world.squares.find_by(x: x + 1, y: y)&amp;.terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">        west: world.squares.find_by(x: x - 1, y: y)&amp;.terrain</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      # Generate code using OpenAI</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      generated_code = OpenaiService.generate_terrain_code(terrain, adjacent_squares)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">      # Update square with new terrain and code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">        active: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">        terrain_type: terrain,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">        code: generated_code</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    Rails.logger.error(&quot;Error activating square: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="43">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="45">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def generate_unique_square_id</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="46">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    self.square_id = SecureRandom.hex(10)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="49">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def ensure_single_treasure</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="50">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    if treasure_changed? &amp;&amp; treasure</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      world.squares.where.not(id: id).update_all(treasure: false)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="646b5ec673b8862ab13b4639c9b8f7a97beac44f">
  <div class="header">
    <h3>app/models/user.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>14</b> relevant lines.
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class User &lt; ActiveRecord::Base</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_secure_password</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="3">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">  before_save { |user| user.email = user.email.downcase }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_save :create_session_token</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :name, presence: true, length: { maximum: 50 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  VALID_EMAIL_REGEX = /\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :email, presence: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">                    format: { with: VALID_EMAIL_REGEX },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">                    uniqueness: { case_sensitive: false }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :password, presence: true, length: { minimum: 6 }, on: :create</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :password_confirmation, presence: true, on: :create</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def create_session_token</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="16">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    self.session_token = SecureRandom.urlsafe_base64</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="18">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :user_worlds</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="19">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :worlds, :through =&gt; :user_worlds</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7142763a24b9b72e2813bb6fe81293f1b9f422e9">
  <div class="header">
    <h3>app/models/user_world.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>9</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class UserWorld &lt; ActiveRecord::Base</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  before_create :generate_unique_user_world_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  def generate_unique_user_world_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      self.user_world_id = SecureRandom.hex(10) # Generates a 20-character hex string</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">  belongs_to :world</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f530784403ecd253d3c307afab43db653b927825">
  <div class="header">
    <h3>app/models/world.rb</h3>
    <h4>
      <span class="red">
  64.71%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>17</b> relevant lines.
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class World &lt; ActiveRecord::Base</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_create :generate_unique_world_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :user_worlds, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :users, through: :user_worlds</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :squares, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :characters, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :invitations, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def storm</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    # Get all squares in the world</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    squares_to_shuffle = squares.to_a</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    # Shuffle the squares</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    shuffled_squares = squares_to_shuffle.shuffle</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    # Update each square with new coordinates</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    shuffled_squares.each_with_index do |square, index|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      new_x = index % 6  # Assuming a 6x6 grid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      new_y = index / 6</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      square.update(x: new_x, y: new_y)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="25">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def generate_unique_world_id</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="28">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    self.world_id = SecureRandom.hex(10) # Generates a 20-character hex string</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a63af90be4f84f247279104ae8ca657e19d0427e">
  <div class="header">
    <h3>app/services/fake_payment_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>15</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>15</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class FakePaymentService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def self.charge(price, credit_card)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">    # Would actually charge to card using price after validating success</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">    valid_card?(credit_card)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Only accepts Visa cards (begins with 4)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  def self.valid_card?(credit_card)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    valid_number = credit_card[:card_number].to_s.match?(/\A4[0-9]{12}(?:[0-9]{3})?\z/)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    valid_date = credit_card[:expiration_date].to_s.match?(/\A(0[1-9]|1[0-2])\/\d{2}\z/)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    valid_cvv = credit_card[:cvv].to_s.match?(/\A\d{3}\z/)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    return { status: &quot;Failure&quot;, error: &quot;Invalid credit card number&quot; } unless valid_number</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    return { status: &quot;Failure&quot;, error: &quot;Invalid expiration date&quot; } unless valid_date</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    return { status: &quot;Failure&quot;, error: &quot;Invalid cvv&quot; } unless valid_cvv</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    return { status: &quot;Success&quot;, transaction_id: &quot;txn_#{SecureRandom.hex(8)}&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5fd694065847678d86cc57c298f96581bb20fb08">
  <div class="header">
    <h3>app/services/open_exchange_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>21</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>21</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require &#39;net/http&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">require &#39;json&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">class OpenExchangeService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  BASE_URL = &#39;https://openexchangerates.org/api&#39;.freeze</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  APP_ID = ENV[&#39;OPEN_EXCHANGE_APP_ID&#39;] # Store your API key securely in the environment</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  def self.fetch_currencies</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    url = URI(&quot;#{BASE_URL}/currencies.json?app_id=#{APP_ID}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    response = Net::HTTP.get(url)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    JSON.parse(response) # Returns a hash of currency codes and names</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">  rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    Rails.logger.error(&quot;Error fetching currencies: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    {}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">  def self.fetch_exchange_rates</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    url = URI(&quot;#{BASE_URL}/latest.json?app_id=#{APP_ID}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    response = Net::HTTP.get(url)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    JSON.parse(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">  rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    Rails.logger.error(&quot;Error fetching exchange rates: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5418263317411b8042b0e65f068c80fb6ba99d0f">
  <div class="header">
    <h3>app/services/openai_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>90</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>90</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class OpenaiService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">    def self.client</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">      @client ||= OpenAI::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">        access_token: ENV[&#39;OPENAI_API_KEY&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">        log_errors: Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    def self.generate_terrain_code(terrain_type, context = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      response = client.chat(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">        parameters: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">          model: &quot;gpt-3.5-turbo&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">          messages: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">            {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">              role: &quot;system&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">              content: terrain_system_prompt</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">            },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">            {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">              role: &quot;user&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">              content: terrain_user_prompt(terrain_type, context)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">          ],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">          temperature: 0.7</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      raw_code = response.dig(&#39;choices&#39;, 0, &#39;message&#39;, &#39;content&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      format_js_code(raw_code)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      Rails.logger.error(&quot;Error generating terrain code: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    def self.format_js_code(raw_code)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      raw_code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">        .gsub(/```(javascript|js)?\n?/, &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">        .gsub(/```/, &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    def self.terrain_system_prompt</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        You are a JavaScript canvas expert creating connected terrain patterns.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">        TERRAIN RULES:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">        - Forest: Deep green (#228B22), must connect with adjacent forest tiles to form areas of 4 connected tiles. Add darker green (#006400) tree shapes.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">        - Desert: Single sandy color (#DEB887) for base, use slightly darker sand color (#C19A6B) for dune lines only. Must be single isolated tiles, no direct adjacency.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">        - Water: Ocean blue (#1E90FF), must connect with 2 other water tiles to form groups of 3.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">        - Plains: Light green (#90EE90), must connect with exactly one other plains tile to form pairs. Add darker green grass details.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">        CONNECTION RULES:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">        - Terrains must seamlessly connect with matching adjacent tiles</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">        - Edges must align perfectly with neighboring tiles</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">        - Use smooth transitions between different terrain types</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">        - Maintain consistent base colors within each terrain type</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">        DESERT SPECIFIC:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">        - Use ONLY #DEB887 as the base color for ALL desert tiles</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">        - Draw dune lines using #C19A6B (slightly darker sand color)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">        - Dune lines should be curved and natural looking</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">        - No variation in the base color between desert tiles</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">        - Only the dune line patterns should differ</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">        CRITICAL:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">        - Do not create canvas or context variables</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">        - Use only the provided &#39;ctx&#39; variable</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">        - Generate only the drawing code</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">      PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    def self.terrain_user_prompt(terrain_type, context)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">      base_prompt = &quot;Generate JavaScript code for a #{terrain_type} tile (105x105 canvas).&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">      # Add specific rules based on terrain type and adjacent tiles</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">      case terrain_type</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      when &quot;forest&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">        base_prompt += &quot;\nThis forest tile must connect with adjacent forest tiles to form a larger forest area covering 4 connected tiles.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">        base_prompt += &quot;\nUse deep green (#228B22) as the base color and add darker green (#006400) tree shapes.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">      when &quot;desert&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">        base_prompt += &quot;\nThis must be an isolated desert tile with no direct desert neighbors.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">        base_prompt += &quot;\nUse ONLY #DEB887 as the base color and #C19A6B for dune line details.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">        base_prompt += &quot;\nDraw curved dune lines to show sand patterns, but keep the base color consistent.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">      when &quot;water&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">        base_prompt += &quot;\nThis water tile must connect with two other water tiles to form a group of three.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">        base_prompt += &quot;\nUse ocean blue (#1E90FF).&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">      when &quot;plains&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">        base_prompt += &quot;\nThis plains tile must connect with exactly one other plains tile to form a pair.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">        base_prompt += &quot;\nUse light green (#90EE90) as base and add darker grass detail lines.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">      # Include context about adjacent terrains to inform connections</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">      if context.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">        base_prompt += &quot;\nAdjacent terrains:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">        context.each do |direction, terrain|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">          base_prompt += &quot;\n#{direction.capitalize}: #{terrain || &#39;unknown&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">      base_prompt += &quot;\nEnsure seamless connections with matching adjacent terrains.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">      base_prompt += &quot;\nUse only the &#39;ctx&#39; variable to draw.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">      base_prompt += &quot;\nDo not create canvas or context variables.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">      base_prompt</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c435cb53ac61b47f2879aa1c55f410c8d9dab8ab">
  <div class="header">
    <h3>app/services/store_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>22</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class StoreService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def self.fetch_prices(currency)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    exchange_rates = fetch_exchange_rates</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">    # Base USD prices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    usd_prices = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">      sea_shard_1: 0.75,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      pile_of_shards_10: 7.50,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      hat_of_shards_50: 30.00,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      chest_of_shards_100: 50.00</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    # Convert prices to the user&#39;s selected currency</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    new_prices = usd_prices.transform_values { |usd_price| (usd_price * exchange_rates[currency]).round(2).to_s }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    new_prices.transform_values! { |value| &#39;%.2f&#39; % value.to_f }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">  def self.fetch_exchange_rates</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    cached_rates = Rails.cache.fetch(&#39;exchange_rates&#39;, expires_in: 12.hours) do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      OpenExchangeService.fetch_exchange_rates</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    cached_rates[&#39;rates&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">  rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    Rails.logger.error &quot;Exception fetching exchange rates: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    { &#39;USD&#39; =&gt; 1.0 }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
